<!DOCTYPE html>
<html id="mainHtml" lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mirror-Smile</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mirror-Smile">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a0c10">

    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation"></script>
    <style>
        * { box-sizing: border-box; }
        :root { --accent: #4ebaba; --bg-glass: rgba(15, 20, 25, 0.92); --text-main: #e0e0e0; --warning: #ffb74d; --record: #ff5252; }
        
        body { margin: 0; background: #0a0c10; overflow: hidden; font-family: 'Segoe UI', Roboto, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; color: var(--text-main); }
        
        .screen { position: absolute; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 200; transition: opacity 0.4s ease; padding: 20px; }
        
        canvas { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); max-width: 100%; max-height: 100%; object-fit: contain; display: none; }
        video { display: none; }

        #lang-toggle {
            position: absolute; top: 50px; left: 20px; z-index: 500;
            background: rgba(255,255,255,0.15); border: 1.5px solid var(--accent);
            color: var(--accent); padding: 10px 18px; border-radius: 25px;
            cursor: pointer; font-size: 14px; font-weight: bold; backdrop-filter: blur(5px);
        }

        .content-card { 
            text-align: center; padding: 25px; width: 90vw; max-width: 450px; max-height: 85vh;
            background: var(--bg-glass); border-radius: 30px; backdrop-filter: blur(15px); 
            border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 15px 35px rgba(0,0,0,0.5); 
            overflow-y: auto; scrollbar-width: none; -ms-overflow-style: none;
        }
        .content-card::-webkit-scrollbar { display: none; }
        
        #app-logo { 
            width: 110px; height: 110px; 
            margin-bottom: 20px; 
            border-radius: 22px; 
            border: 2.5px solid var(--accent); 
            background: #ffffff; 
            object-fit: contain; 
            padding: 8px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            opacity: 1 !important;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }

        h1 { font-size: 28px; margin: 0 0 5px 0; color: #fff; }
        .sub-title { font-size: 14px; color: var(--accent); margin-bottom: 25px; opacity: 1; font-weight: 500; }
        h2 { font-size: 19px; color: var(--accent); margin-bottom: 15px; border-bottom: 1px solid rgba(78, 186, 186, 0.3); padding-bottom: 8px; }
        
        .info-text { text-align: inherit; font-size: 13.5px; line-height: 1.6; margin-bottom: 20px; color: #f0f0f0; }
        .instructions-list { text-align: inherit; margin: 15px 0; padding: 0; list-style: none; width: 100%; }
        .instructions-list li { margin-bottom: 12px; font-size: 13px; line-height: 1.5; display: flex; align-items: flex-start; gap: 8px; }
        .instructions-list li::before { content: "â€¢"; color: var(--accent); font-weight: bold; flex-shrink: 0; margin-top: 2px; }
        
        .btn-group { display: flex; flex-direction: column; gap: 12px; width: 100%; align-items: center; }
        .main-btn { width: 100%; max-width: 260px; padding: 14px; border-radius: 30px; background: var(--accent); color: #000; font-size: 16px; font-weight: 700; border: none; cursor: pointer; }
        .secondary-btn { width: 100%; max-width: 260px; padding: 11px; border-radius: 30px; background: transparent; color: var(--accent); font-size: 14px; border: 1.5px solid var(--accent); cursor: pointer; }
        
        .disclaimer-box { background: rgba(255, 183, 77, 0.12); border: 1px solid var(--warning); padding: 18px; border-radius: 20px; text-align: inherit; margin-bottom: 20px; width: 100%; }
        .disclaimer-box h3 { color: var(--warning); margin-top: 0; font-size: 18px; margin-bottom: 12px; }

        #ui { position: absolute; bottom: 40px; width: 100%; display: none; flex-direction: column; align-items: center; gap: 15px; z-index: 100; padding: 0 10px; }
        .controls-row { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
        button.tool-btn { padding: 10px 14px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: #fff; cursor: pointer; font-size: 14px; }
        button.active { background: var(--accent); color: #000; }
        button.recording { background: var(--record); color: #fff; animation: blink 1.5s infinite; }

        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .watermark { position: absolute; bottom: 10px; font-size: 10px; color: rgba(255,255,255,0.25); z-index: 210; width: 100%; text-align: center; pointer-events: none; }
        
        .modal { display: none; position: fixed; z-index: 300; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); justify-content: center; align-items: center; }
        .modal-content { background: #1a1e23; padding: 25px; border-radius: 25px; width: 85%; max-width: 380px; text-align: inherit; border: 1px solid var(--accent); }
    </style>
</head>
<body>

    <button id="lang-toggle" onclick="toggleLanguage()">English</button>

    <div id="screen-1" class="screen">
        <div class="content-card">
            <img src="logo.png" id="app-logo" alt="Mirror-Smile Logo">
            <h1 data-i18n="app_title">Mirror-Smile</h1>
            <div class="sub-title" data-i18n="app_subtitle">×¤×•×ª×—×” ×¢×œ ×™×“×™ ×“×§×œ ×¦×™×“×•×Ÿ ×•×™×©×™ ×–×‘×•×œ×•×Ÿ</div>
            <div class="btn-group">
                <button class="main-btn" onclick="showScreen(3)" data-i18n="btn_instructions">×œ×”×•×¨××•×ª ×”×©×™××•×©</button>
                <button class="secondary-btn" onclick="showScreen(2)" data-i18n="btn_about">××•×“×•×ª ×”××¤×œ×™×§×¦×™×”</button>
            </div>
        </div>
    </div>

    <div id="screen-2" class="screen" style="display:none; opacity:0;">
        <div class="content-card">
            <h2 data-i18n="about_title">××•×“×•×ª Mirror-Smile</h2>
            <div class="info-text" data-i18n="about_content">
                <p><strong>Mirror-Smile</strong> × ×•×œ×“×” ××ª×•×š ×¢×§×¨×•×Ÿ ×”× ×•×™×¨×•×¤×œ×¡×˜×™×•×ª â€” ×™×›×•×œ×ª×• ×©×œ ×”××•×— ×œ×”×©×ª× ×•×ª, ×œ×”×¡×ª×’×œ ×•×œ×”×—×œ×™× ×‘×¢×§×‘×•×ª ××™××•×Ÿ, ×—×–×¨×” ×•××©×•×‘ ××ª××™×.</p>
                <p>×¢×™×§×¨×•×Ÿ ×–×” ××ª×•××¨ ×‘×”×¨×—×‘×” ×‘×¡×¤×¨ â€×”××•×— ×”×’××™×©â€ (The Brain That Changes Itself) ×××ª × ×•×¨××Ÿ ×“×•×™×“×’â€™.</p>
                <p>×”××¤×œ×™×§×¦×™×” ××‘×•×¡×¡×ª ×¢×œ ×¢×§×¨×•× ×•×ª Mirror Therapy ×©×¤×•×ª×—×” ×¢×œâ€‘×™×“×™ ×”× ×•×™×¨×•×œ×•×’ <strong>Vilayanur S. Ramachandran</strong>.</p>
            </div>
            <div class="btn-group">
                <button class="secondary-btn" onclick="openModal('usersModal')" data-i18n="btn_call_users">×§×¨×™××” ×œ××©×ª××©×™×</button>
                <button class="secondary-btn" onclick="openModal('researchModal')" data-i18n="btn_call_research">×§×¨×™××” ×œ×—×•×§×¨×™×</button>
                <button class="main-btn" onclick="showScreen(3)" data-i18n="btn_continue">×œ×”××©×š ×œ×”×•×¨××•×ª</button>
            </div>
        </div>
    </div>

    <div id="screen-3" class="screen" style="display:none; opacity:0;">
        <div class="content-card">
            <h2 data-i18n="instr_title">×”×•×¨××•×ª ×©×™××•×©</h2>
            <ul class="instructions-list" data-i18n="instr_list">
                <li>×”×¦×‘ ××ª ×”××›×©×™×¨ ×¢×œ ×—×¦×•×‘×”, ×™×©×™×¨×•×ª ××•×œ ×”×¤× ×™× â€” ×‘×“×•××” ×œ××¨××”</li>
                <li>×“××’ ×œ×ª××•×¨×” ××—×™×“×”, ×¡×‘×™×‘×” ×©×§×˜×” ×•×¤×¨×˜×™×•×ª</li>
                <li>××§× ××ª ×”×¤× ×™× ×‘××¨×›×– ×”××¡×š, ××‘×˜ ×™×©×¨ ×§×“×™××”</li>
                <li>×©×›×¤×œ ××ª ×”×¦×“ ×”×‘×¨×™× ×•×—×¤×© ×¡×™××˜×¨×™×” × ×•×—×” ×•×˜×‘×¢×™×ª</li>
                <li>×ª×¨×’×œ ×‘×¢×–×¨×ª ×©×ª×™ ×”×™×“×™×™× ×‘××§×‘×™×œ, ×‘×”×ª×× ×œ×”× ×—×™×•×ª ×”××˜×¤×œ ×©×œ×š</li>
            </ul>
            <button class="main-btn" onclick="showScreen(4)" data-i18n="btn_to_disclaimer">×”××©×š ×œ××—×¨×™×•×ª ×©×™××•×©</button>
        </div>
    </div>

    <div id="screen-4" class="screen" style="display:none; opacity:0;">
        <div class="content-card">
            <div class="disclaimer-box">
                <h3 data-i18n="disc_title">××—×¨×™×•×ª ×”××©×ª××©</h3>
                <div id="disc_text" data-i18n="disc_content">
                    <p>××¤×œ×™×§×¦×™×” ×–×• ××™× ×” ××›×©×™×¨ ×¨×¤×•××™ ×•××™× ×” ××”×•×•×” ×™×™×¢×•×¥ ×¨×¤×•××™.</p>
                    <p>×”×©×™××•×© × ×¢×©×” ×‘××—×¨×™×•×ª ×”××©×ª××© ×‘×œ×‘×“. ××™×Ÿ ×œ×©× ×•×ª ×˜×™×¤×•×œ ×œ×œ× ×”×ª×™×™×¢×¦×•×ª ×¢× ×¨×•×¤×.</p>
                    <p>×‘××§×¨×” ×©×œ ×›××‘ ××• ×¡×¤×§ â€” ×™×© ×œ×”×¤×¡×™×§ ××ª ×”×©×™××•×© ×•×œ×¤× ×•×ª ×œ××™×© ××§×¦×•×¢.</p>
                </div>
            </div>
            <button class="main-btn" onclick="startCamera()" data-i18n="btn_start">×”×‘× ×ª×™, ×‘×•××• × ×ª×—×™×œ</button>
        </div>
    </div>

    <video id="videoElement" playsinline autoplay muted></video>
    <canvas id="mainCanvas"></canvas>
    <canvas id="tempCanvas" style="display:none"></canvas>

    <div id="ui">
        <div class="controls-row">
            <button onclick="setMode('none')" id="btnNone" class="tool-btn active" data-i18n="btn_normal">×¨×’×™×œ</button>
            <button onclick="setMode('left')" id="btnLeft" class="tool-btn" data-i18n="btn_left">×©×××œ</button>
            <button onclick="setMode('right')" id="btnRight" class="tool-btn" data-i18n="btn_right">×™××™×Ÿ</button>
            <button onclick="takeSnapshot()" class="tool-btn">ğŸ“¸</button>
            <button onclick="toggleVideoRecording()" id="btnRecord" class="tool-btn">ğŸ“¹</button>
            <button onclick="finishSession()" class="tool-btn" style="background: rgba(255,255,255,0.2); border-color: #fff;" data-i18n="btn_finish">×¡×™×•× âœ–</button>
        </div>
    </div>
    <div class="watermark">Â© 2026 | Mirror-Smile | Developed by Dekel Tzidon & Yishay Zvulun</div>

    <div id="usersModal" class="modal"><div class="modal-content"><h3 data-i18n="modal_users_title">×§×¨×™××” ×œ××©×ª××©×™×</h3><p data-i18n="modal_users_body">×× ×• ××–××™× ×™× ×× ×©×™× ×”×¡×•×‘×œ×™× ××©×™×ª×•×§ ×¢×¦×‘ ×”×¤× ×™× ×œ×”×©×ª××© ×‘-Mirror-Smile. × ×©××— ×œ××©×•×‘.</p><button class="close-modal" onclick="closeModal('usersModal')" data-i18n="btn_close">×¡×’×•×¨</button></div></div>
    <div id="researchModal" class="modal"><div class="modal-content"><h3 data-i18n="modal_res_title">×§×¨×™××” ×œ×—×•×§×¨×™×</h3><p data-i18n="modal_res_body">×—×•×§×¨×™× ××•×–×× ×™× ×œ×”×©×ª××© ×‘××¤×œ×™×§×¦×™×” ×œ××—×§×¨ ×¢× ×§×¨×“×™×˜ ××ª××™×.</p><button class="close-modal" onclick="closeModal('researchModal')" data-i18n="btn_close">×¡×’×•×¨</button></div></div>

    <script>
        const i18n = {
            he: {
                dir: 'rtl', lang_btn: 'English',
                app_title: 'Mirror-Smile', app_subtitle: '×¤×•×ª×—×” ×¢×œ ×™×“×™ ×“×§×œ ×¦×™×“×•×Ÿ ×•×™×©×™ ×–×‘×•×œ×•×Ÿ',
                btn_instructions: '×œ×”×•×¨××•×ª ×”×©×™××•×©', btn_about: '××•×“×•×ª ×”××¤×œ×™×§×¦×™×”',
                about_title: '××•×“×•×ª Mirror-Smile',
                about_content: `<p><strong>Mirror-Smile</strong> × ×•×œ×“×” ××ª×•×š ×¢×§×¨×•×Ÿ ×”× ×•×™×¨×•×¤×œ×¡×˜×™×•×ª â€” ×™×›×•×œ×ª×• ×©×œ ×”××•×— ×œ×”×©×ª× ×•×ª, ×œ×”×¡×ª×’×œ ×•×œ×”×—×œ×™× ×‘×¢×§×‘×•×ª ××™××•×Ÿ, ×—×–×¨×” ×•××©×•×‘ ××ª××™×.</p><p>×¢×™×§×¨×•×Ÿ ×–×” ××ª×•××¨ ×‘×”×¨×—×‘×” ×‘×¡×¤×¨ â€×”××•×— ×”×’××™×©â€ (The Brain That Changes Itself) ×××ª × ×•×¨××Ÿ ×“×•×™×“×’â€™.</p><p>×”××¤×œ×™×§×¦×™×” ××‘×•×¡×¡×ª ×¢×œ ×¢×§×¨×•× ×•×ª Mirror Therapy ×©×¤×•×ª×—×” ×¢×œâ€‘×™×“×™ ×”× ×•×™×¨×•×œ×•×’ <strong>Vilayanur S. Ramachandran</strong>.</p>`,
                btn_call_users: '×§×¨×™××” ×œ××©×ª××©×™×', btn_call_research: '×§×¨×™××” ×œ×—×•×§×¨×™×', btn_continue: '×œ×”××©×š ×œ×”×•×¨××•×ª',
                instr_title: '×”×•×¨××•×ª ×©×™××•×©',
                instr_list: `<li>×”×¦×‘ ××ª ×”××›×©×™×¨ ×¢×œ ×—×¦×•×‘×”, ×™×©×™×¨×•×ª ××•×œ ×”×¤× ×™× â€” ×‘×“×•××” ×œ××¨××”</li><li>×“××’ ×œ×ª××•×¨×” ××—×™×“×”, ×¡×‘×™×‘×” ×©×§×˜×” ×•×¤×¨×˜×™×•×ª</li><li>××§× ××ª ×”×¤× ×™× ×‘××¨×›×– ×”××¡×š, ××‘×˜ ×™×©×¨ ×§×“×™××”</li><li>×©×›×¤×œ ××ª ×”×¦×“ ×”×‘×¨×™× ×•×—×¤×© ×¡×™××˜×¨×™×” × ×•×—×” ×•×˜×‘×¢×™×ª</li><li>×ª×¨×’×œ ×‘×¢×–×¨×ª ×©×ª×™ ×”×™×“×™×™× ×‘××§×‘×™×œ, ×‘×”×ª×× ×œ×”× ×—×™×•×ª ×”××˜×¤×œ ×©×œ×š</li>`,
                btn_to_disclaimer: '×”××©×š ×œ××—×¨×™×•×ª ×©×™××•×©',
                disc_title: '××—×¨×™×•×ª ×”××©×ª××©',
                disc_content: `<p>××¤×œ×™×§×¦×™×” ×–×• ××™× ×” ××›×©×™×¨ ×¨×¤×•××™ ×•××™× ×” ××”×•×•×” ×™×™×¢×•×¥ ×¨×¤×•××™.</p><p>×”×©×™××•×© × ×¢×©×” ×‘××—×¨×™×•×ª ×”××©×ª××© ×‘×œ×‘×“. ××™×Ÿ ×œ×©× ×•×ª ×˜×™×¤×•×œ ×œ×œ× ×”×ª×™×™×¢×¦×•×ª ×¢× ×¨×•×¤×.</p><p>×‘××§×¨×” ×©×œ ×›××‘ ××• ×¡×¤×§ â€” ×™×© ×œ×”×¤×¡×™×§ ××ª ×”×©×™××•×© ×•×œ×¤× ×•×ª ×œ××™×© ××§×¦×•×¢.</p>`,
                btn_start: '×”×‘× ×ª×™, ×‘×•××• × ×ª×—×™×œ', ui_manual: '×™×“× ×™', ui_auto: '××•×˜×•××˜×™ ğŸ”„',
                btn_normal: '×¨×’×™×œ', btn_left: '×©×××œ', btn_right: '×™××™×Ÿ', btn_finish: '×¡×™×•× âœ–',
                modal_users_title: '×§×¨×™××” ×œ××©×ª××©×™×', modal_users_body: '×× ×• ××–××™× ×™× ×× ×©×™× ×”×¡×•×‘×œ×™× ××©×™×ª×•×§ ×¢×¦×‘ ×”×¤× ×™× ×œ×”×©×ª××© ×‘-Mirror-Smile. × ×©××— ×œ××©×•×‘.',
                modal_res_title: '×§×¨×™××” ×œ×—×•×§×¨×™×', modal_res_body: '×—×•×§×¨×™× ××•×–×× ×™× ×œ×”×©×ª××© ×‘××¤×œ×™×§×¦×™×” ×œ××—×§×¨ ×¢× ×§×¨×“×™×˜ ××ª××™×.',
                btn_close: '×¡×’×•×¨', cam_err: '×©×’×™××ª ××¦×œ××”: ×•×•×“× ×©××ª×” ×‘×—×™×‘×•×¨ ×××•×‘×˜×— (HTTPS) ×•× ×ª×ª ×”×¨×©××”.'
            },
            en: {
                dir: 'ltr', lang_btn: '×¢×‘×¨×™×ª',
                app_title: 'Mirror-Smile', app_subtitle: 'Developed by Dekel Tzidon & Yishay Zvulun',
                btn_instructions: 'Usage Instructions', btn_about: 'About the App',
                about_title: 'About Mirror-Smile',
                about_content: `<p><strong>Mirror-Smile</strong> was born from the principle of neuroplasticity â€” the brain's ability to change, adapt, and heal through training and feedback.</p><p>This principle is described in "The Brain That Changes Itself" by Norman Doidge.</p><p>The app is based on Mirror Therapy principles developed by neurologist <strong>Vilayanur S. Ramachandran</strong>.</p>`,
                btn_call_users: 'Call for Users', btn_call_research: 'Call for Researchers', btn_continue: 'Continue to Instructions',
                instr_title: 'Instructions',
                instr_list: `<li>Place the device on a tripod, directly in front of your face.</li><li>Ensure uniform lighting and a quiet environment.</li><li>Position your face in the center, looking straight ahead.</li><li>Mirror the healthy side and find a comfortable symmetry.</li><li>Practice using both hands simultaneously as guided by your therapist.</li>`,
                btn_to_disclaimer: 'Continue to Disclaimer',
                disc_title: 'User Responsibility',
                disc_content: `<p>This app is not a medical device and does not constitute medical advice.</p><p>Use is at the user\'s sole responsibility. Do not change treatment without consulting a doctor.</p><p>In case of pain or doubt â€” stop use and consult a professional.</p>`,
                btn_start: 'I Understand, Let\'s Start', ui_manual: 'Manual', ui_auto: 'Auto ğŸ”„',
                btn_normal: 'Normal', btn_left: 'Left', btn_right: 'Right', btn_finish: 'Finish âœ–',
                modal_users_title: 'Call for Users', modal_users_body: 'We invite people with facial nerve paralysis to use Mirror-Smile. We welcome your feedback.',
                modal_res_title: 'Call for Researchers', modal_res_body: 'Researchers are invited to use the app with proper credit.',
                btn_close: 'Close', cam_err: 'Camera Error: Ensure HTTPS connection and camera permissions.'
            }
        };

        let currentLang = 'he';

        function toggleLanguage() {
            currentLang = (currentLang === 'he') ? 'en' : 'he';
            const langData = i18n[currentLang];
            document.getElementById('mainHtml').dir = langData.dir;
            document.getElementById('lang-toggle').innerText = langData.lang_btn;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (langData[key]) {
                    if (['UL','DIV','P'].includes(el.tagName)) el.innerHTML = langData[key];
                    else el.innerText = langData[key];
                }
            });
        }

        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const tempCanvas = document.getElementById('tempCanvas');
        const tCtx = tempCanvas.getContext('2d');
        
        let currentMode = 'none', smoothNoseX = 0, selfieSegmentation, streamRef = null;
        let isRecording = false, mediaRecorder, recordedChunks = [];

        function showScreen(num) {
            document.querySelectorAll('.screen').forEach(s => { s.style.opacity = '0'; setTimeout(() => s.style.display = 'none', 400); });
            setTimeout(() => { const t = document.getElementById('screen-' + num); t.style.display = 'flex'; setTimeout(() => t.style.opacity = '1', 50); }, 450);
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        async function startCamera() {
            document.getElementById('lang-toggle').style.display = 'none';
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            canvas.style.display = 'block';
            document.getElementById('ui').style.display = 'flex';
            if (!streamRef) await initModels();
        }

        async function initModels() {
            try {
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/');
                await faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/');
                selfieSegmentation = new SelfieSegmentation({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`});
                selfieSegmentation.setOptions({ modelSelection: 1 });
                selfieSegmentation.onResults(onResults);
                streamRef = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 720 } } 
                }).catch(err => { alert(i18n[currentLang].cam_err); throw err; });
                video.srcObject = streamRef;
                video.onloadedmetadata = () => { canvas.width = tempCanvas.width = video.videoWidth; canvas.height = tempCanvas.height = video.videoHeight; smoothNoseX = canvas.width/2; sendToSegmentation(); };
            } catch (e) { finishSession(); }
        }

        function finishSession() {
            if (streamRef) { streamRef.getTracks().forEach(t => t.stop()); streamRef = null; }
            location.reload();
        }

        async function sendToSegmentation() { if (streamRef && !video.paused && !video.ended) { await selfieSegmentation.send({image: video}); requestAnimationFrame(sendToSegmentation); } }

        function onResults(r) {
            tCtx.save(); tCtx.clearRect(0,0,canvas.width,canvas.height); tCtx.translate(canvas.width,0); tCtx.scale(-1,1);
            tCtx.drawImage(r.segmentationMask, 0,0,canvas.width,canvas.height);
            tCtx.globalCompositeOperation = 'source-in'; tCtx.drawImage(r.image, 0,0,canvas.width,canvas.height); tCtx.restore();
            handleFaceDetection();
            ctx.clearRect(0,0,canvas.width,canvas.height);
            if(currentMode==='none') ctx.drawImage(tempCanvas,0,0);
            else if(currentMode==='left') drawSymmetry(0, smoothNoseX);
            else drawSymmetry(smoothNoseX, canvas.width - smoothNoseX);
            // ×”×§×• (Guide) ×”×•×¡×¨ ×œ×¦××™×ª×•×ª
        }

        async function handleFaceDetection() {
            const d = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();
            if(d.length > 0) {
                const nx = canvas.width - d[0].landmarks.getNose()[0].x;
                smoothNoseX += (nx - smoothNoseX) * 0.15;
            }
        }

        function drawSymmetry(sx, w) {
            ctx.drawImage(tempCanvas, sx, 0, w, canvas.height, sx, 0, w, canvas.height);
            ctx.save(); ctx.translate(smoothNoseX * 2, 0); ctx.scale(-1, 1);
            ctx.drawImage(tempCanvas, sx, 0, w, canvas.height, sx, 0, w, canvas.height); ctx.restore();
        }

        function setMode(m) { 
            currentMode = m; 
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active')); 
            const btnId = 'btn' + m.charAt(0).toUpperCase() + m.slice(1);
            if(document.getElementById(btnId)) document.getElementById(btnId).classList.add('active');
        }

        function takeSnapshot() { const l = document.createElement('a'); l.download = 'Mirror-Smile_Snap.png'; l.href = canvas.toDataURL(); l.click(); }
        function toggleVideoRecording() {
            if (!isRecording) {
                recordedChunks = [];
                mediaRecorder = new MediaRecorder(canvas.captureStream(30), { mimeType: 'video/webm' });
                mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob(recordedChunks, { type: 'video/webm' })); a.download = 'Mirror-Smile_Video.webm'; a.click();
                };
                mediaRecorder.start(); document.getElementById('btnRecord').classList.add('recording'); isRecording = true;
            } else {
                mediaRecorder.stop(); document.getElementById('btnRecord').classList.remove('recording'); isRecording = false;
            }
        }
    </script>
</body>
</html>
